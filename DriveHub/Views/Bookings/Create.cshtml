@model DriveHub.Models.Dto.BookingDto

@{
    ViewData["Title"] = "Make a booking";
}

<div class="row mt-2">
    <div class="col-xs-0 col-md-1 col-lg-2 col-xl-3"></div>
    <div class="col-xs-12 col-md-10 col-lg-8 col-xl-6">
        <h1 class="text-center">@ViewBag.Title</h1>
        <p class="text-center">Make a new booking for @ViewBag.Vehicle</p>
        <div class="mb-3" style="background-color: #f8f9fa;">
            <div class="p-2 fw-bold fs-4" style="background-color: #FFBA17;">
                Booking Details
            </div>

            <div class="p-3">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-geo-alt-fill fs-2 me-3"></i>
                    <div>
                        <p class="mb-0">Pickup DriveHub @ViewBag.StartPod</p>
                        <small>@ViewBag.StartSite</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Car:</label>
                    <div class="form-control">@ViewBag.Vehicle</div>
                    <a href="/Bookings/Search" class="small text-end d-block mt-1 btn btn-primary">Find another car close by</a>
                </div>
                <form asp-action="Create">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="VehicleId" />
                    <input type="hidden" asp-for="QuotedPricePerHour" value="@ViewBag.PricePerHour" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="StartTime" class="control-label">Booking Start</label>
                            <input asp-for="StartTime" class="form-control" id="StartTime" />
                            <span asp-validation-for="StartTime" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="EndTime" class="control-label">Booking End</label>
                            <input asp-for="EndTime" class="form-control" id="EndTime" />
                            <span asp-validation-for="EndTime" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label for="EndPodId" class="control-label">Return Pod</label>
                        <select asp-for="EndPodId" class="form-select" id="EndPodId" asp-items="ViewBag.Pods"></select>
                        <span asp-validation-for="EndPodId" class="text-danger"></span>
                    </div>

                    <div class="booking-section mb-3">
                        <div class="p-2 fw-bold fs-4" style="background-color: #FFBA17;">Booking Cost</div>
                        <div class="cost-section text-center bg-white p-3" style="border: 1px solid #dee2e6;">
                            <p class="mb-0">Per Hour:</p>
                            <p class="fw-bold fs-1">$<span id="price-per-hour">@ViewBag.PricePerHour.ToString("F2")</span><hr></p>
                            <hr />
                            <p class="mb-0">Total Cost:</p>
                            <p class="fw-bold fs-1 mb-6" id="total-cost">$0</p>
                        </div>
                    </div>
                    <div class="text-center">
                        <input type="submit" value="Create" class="btn btn-primary mb-4 fw-bold text-white fs-4 text-center" />
                    </div>
                </form>
                    </div>
            </div>

            <div id="map" style="height: 400px; width: 100%; background-color: #f8f9fa;" class="col-12">
            </div>
        </div>
        <div class="col-xs-0 col-md-1 col-lg-2 col-xl-3"></div>
    </div>
</div>

<script>
    // Format the price above to AUD using the locale, style, and currency.
let AUDollar = new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
});
    var quotedPricePerHour = @ViewBag.PricePerHour;
    var quotedPrice = 0;
    var startTime;
    var endTime;

    document.querySelector('#StartTime').addEventListener('change', function () {
        startTime = this.value;
        console.log(startTime);
    });

    document.querySelector('#EndTime').addEventListener('change', function () {
        endTime = this.value;
        console.log(endTime);

        if (startTime != null) {
            var diff = Math.abs(new Date(startTime) - new Date(endTime));
            let minutes = Math.floor((diff/1000)/60);
            quotedPrice = minutes * quotedPricePerHour/60;
            console.log("price = " + quotedPrice);
            if (quotedPrice > 0) document.getElementById("total-cost").innerHTML = `${AUDollar.format(quotedPrice)}`;
        }
    });

    function initMap() {
            // Init Google Map
                let map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: @ViewBag.StartSiteLatitude, lng: @ViewBag.StartSiteLongitude },
            zoom: 19,
            mapTypeId: "roadmap",
            mapId: "DRIVEHUB_CREATE"
        });
        new google.maps.marker.AdvancedMarkerElement({
            map,
            title: "Vehicle",
            position: { lat: @ViewBag.StartSiteLatitude, lng: @ViewBag.StartSiteLongitude }
        })
        }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBRV0yLBAMIA53_1Y3_TW-HD-RPgTDdxc&callback=initMap&v=weekly&libraries=marker,places,geometry&loading=async"
        defer>
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}